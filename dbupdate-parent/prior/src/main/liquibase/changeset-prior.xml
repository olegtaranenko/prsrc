<?xml version="1.0" encoding="CP1251"?>
 
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"
  logicalFilePath="changeset-prior.xml"
>
 
	<include file="../../../../src/main/liquibase/changeset-common.xml" relativeToChangelogFile="true"/>
<!--
	<changeSet id="ddl" author="mantis-7" context="does-not-work">
		<comment>Prepare for repare table xPredmetyByNomenkOut from the backup</comment>
		<sql>
create server priord class 'ASAODBC' USING 'DSN=dev_prior;UID=dba;PWD=sql';

call build_table_one_server('xPredmetyByNomenkOut', 'priord', 1);
		</sql>

		<rollback>
			<sql>
call build_table_one_server('xPredmetyByNomenkOut', 'priord', 0);
drop server priord;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="dml" author="mantis-7" runOnChange="true" context="does-not-work">
		<comment>Correct broken table xPredmetyByNomenkOut from the backup</comment>
		<createProcedure>
begin
	create table #nomOut(outDate timestamp, numorder integer, nomnom varchar(50), quant float, used integer);

	insert into #nomOut
	select outDate, numorder, nomnom, quant, 0
	from xPredmetyByNomenkOut_priord o;


	for x as xx dynamic scroll cursor for
		select numorder as r_numorder, nomnom as r_nomnom, quant as r_quant from xPredmetyByNomenkOut for update
	do
		lea:
		for y as yy dynamic scroll cursor for
			select outDate as r_outDate from #nomOut o where o.numorder = r_numorder and o.nomnom = r_nomnom and quant = r_quant and o.used = 0 for update
		do
			update xPredmetyByNomenkOut set outDate = r_outDate where current of xx;
			update #nomOut set used = 1 where current of yy;
			leave lea;
		end for;
		commit;
	end for;

end;
		</createProcedure>
	</changeSet>
-->

	<changeSet id="mantis-11" author="ddl">
		<comment>Temporarly restore sales functionality</comment>
		<addColumn tableName="bayguidefirms">
			<column name="oborud" type="varchar(10)"><constraints nullable="true"/></column>
		</addColumn>
		<addColumn tableName="bayguidefirms">
			<column name="kategor" type="varchar(50)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
	

<!--
	<changeSet id="mantis-11" author="test-exception" runOnChange="true">
		<sql splitStatements="true" stripComments="true" endDelimiter=";">

	truncate table sdmcventure;
	truncate table sdocsventure;

//	call bootstrap_blocking();

	call cre_block_var('supress_cum_update');
	call cre_block_var('supress_diary_update');
	waitfor delay convert(time, '00:00:01.000');

//	call cre_block_var('supress_cum_update');
//	call cre_block_var('supress_diary_update');

//	call cre_block_var('blocks_inited');

	call ivo_generate(10);


		</sql>
	</changeSet>

	<changeSet id="mantis-10" author="correct-ivo" runOnChange="true">
		<sqlFile path="src/main/liquibase/correct-ivo.sql" splitStatements="false" stripComments="false"/>
	</changeSet>
-->

	<changeSet id="mantis-10" author="code" runOnChange="true">
		<comment>Процедуры для анализа продаж</comment>
		<sqlFile path="src/main/liquibase/sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


<!--
	<changeSet id="mantis-10" author="rowmat-dml" runAlways="true">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>

		<sqlFile path="src/main/liquibase/sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sql splitStatements="false" stripComments="false"><![CDATA[

		]]></sql>
	</changeSet>
-->
	<changeSet id="mantis-10" author="rowmat-dml">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>
		<sqlFile path="src/main/liquibase/sales-analys-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="mantis-14" author="prior">
		<comment>Удалить ошибочно заведенный заказ</comment>
		<delete tableName="xPredmetyByIzdelia">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="orders">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="sdmcrez">
			<where>numdoc = 8102012</where>
		</delete>
	</changeSet>


	<changeSet id="mantis-19" author="prior-ddl">
		<comment>Перенести отчет по оборотам средств по предприятиям в Stime</comment>
		<addColumn tableName="nAnalys">
			<column name="application" type="varchar(16)"/>
		</addColumn>
		<update tableName="nAnalys">
			<column name="application" value="bay"/>
		</update>
		<update tableName="nAnalys">
			<column name="application" value="stime"/>
			<where>id = 7</where>
		</update>
<!--
		<modifyColumn tableName="nAnalys">
			<column name="application" >
				<constraints nullable="true"/>
			</column>
		</modifyColumn>
-->
	</changeSet>

<!--
	<changeSet id="mantis-12" author="code" runOnChange="true">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="src/main/liquibase/nomnom-firma.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


	<changeSet id="mantis-12" author="dml">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="src/main/liquibase/nomnom-firma-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="bay-analys" author="dml">
		<comment>Пропущенные при дизайне ЕР-схемы ключи ссылок</comment>
		<addForeignKeyConstraint constraintName="f_fk_row_col" baseTableName="nFilter" baseColumnNames="byrowid, bycolumnid"
    	referencedTableName="nAnalys" referencedColumnNames="byrow, bycolumn"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nAnalysBooting" constraintName="nab_param" baseColumnNames="paramId"
    	referencedTableName="nAnalysBootingParam" referencedColumnNames="id"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nHeaderColumSelected" constraintName="nhcs_manag" baseColumnNames="managerId"
    	referencedTableName="GuideManag" referencedColumnNames="managId"
    	onDelete="SET NULL" onUpdate="CASCADE"
    	/>
	</changeSet>
-->

<!--
!!! почему-то не работает из-под ликвибейза. Возможно неправильно настрое автокоммит?? хорошо бы разобраться...

	<changeSet id="mantis-23" author="dml">
		<comment>синхронизировать справочник фирм с бухгалтерскими базами комтеха.</comment>
		<sqlFile path="src/main/liquibase/sync_guidefirms.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
-->

	<changeSet id="ddl-1" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="orders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="ddl-2" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="bayOrders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="dml-1" author="mantis-33">
		<comment>Установка Курса по умолчанию</comment>
		<update tableName="orders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="orders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>

		<update tableName="bayOrders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="bayOrders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>
		
		<rollback/>
	</changeSet>


	<changeSet id="code-1" author="mantis-33" runOnChange="true">
		<comment>Курс заказа: триггеры для orders</comment>
		<sqlFile path="src/main/liquibase/mantis-33.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

</databaseChangeLog>

