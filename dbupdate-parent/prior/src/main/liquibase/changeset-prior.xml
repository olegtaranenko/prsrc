<?xml version="1.0" encoding="CP1251"?>
 
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"
  logicalFilePath="changeset-prior.xml"
>
 

	<include file="changeset-common.xml"/>
<!--

	<changeSet id="ddl" author="mantis-7" context="does-not-work">
		<comment>Prepare for repare table xPredmetyByNomenkOut from the backup</comment>
		<sql>
create server priord class 'ASAODBC' USING 'DSN=dev_prior;UID=dba;PWD=sql';

call build_table_one_server('xPredmetyByNomenkOut', 'priord', 1);
		</sql>

		<rollback>
			<sql>
call build_table_one_server('xPredmetyByNomenkOut', 'priord', 0);
drop server priord;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="dml" author="mantis-7" runOnChange="true" context="does-not-work">
		<comment>Correct broken table xPredmetyByNomenkOut from the backup</comment>
		<createProcedure>
begin
	create table #nomOut(outDate timestamp, numorder integer, nomnom varchar(50), quant float, used integer);

	insert into #nomOut
	select outDate, numorder, nomnom, quant, 0
	from xPredmetyByNomenkOut_priord o;


	for x as xx dynamic scroll cursor for
		select numorder as r_numorder, nomnom as r_nomnom, quant as r_quant from xPredmetyByNomenkOut for update
	do
		lea:
		for y as yy dynamic scroll cursor for
			select outDate as r_outDate from #nomOut o where o.numorder = r_numorder and o.nomnom = r_nomnom and quant = r_quant and o.used = 0 for update
		do
			update xPredmetyByNomenkOut set outDate = r_outDate where current of xx;
			update #nomOut set used = 1 where current of yy;
			leave lea;
		end for;
		commit;
	end for;

end;
		</createProcedure>
	</changeSet>
-->

	<changeSet id="mantis-11" author="ddl">
		<comment>Temporarly restore sales functionality</comment>
		<addColumn tableName="bayguidefirms">
			<column name="oborud" type="varchar(10)"><constraints nullable="true"/></column>
		</addColumn>
		<addColumn tableName="bayguidefirms">
			<column name="kategor" type="varchar(50)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
	

<!--
	<changeSet id="mantis-11" author="test-exception" runOnChange="true">
		<sql splitStatements="true" stripComments="true" endDelimiter=";">

	truncate table sdmcventure;
	truncate table sdocsventure;

//	call bootstrap_blocking();

	call cre_block_var('supress_cum_update');
	call cre_block_var('supress_diary_update');
	waitfor delay convert(time, '00:00:01.000');

//	call cre_block_var('supress_cum_update');
//	call cre_block_var('supress_diary_update');

//	call cre_block_var('blocks_inited');

	call ivo_generate(10);


		</sql>
	</changeSet>

	<changeSet id="mantis-10" author="correct-ivo" runOnChange="true">
		<sqlFile path="correct-ivo.sql" splitStatements="false" stripComments="false"/>
	</changeSet>
-->

	<changeSet id="mantis-10" author="code" runOnChange="true">
		<comment>Процедуры для анализа продаж</comment>
		<sqlFile path="procedures/sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


<!--
	<changeSet id="mantis-10" author="rowmat-dml" runAlways="true">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>

		<sqlFile path="sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sql splitStatements="false" stripComments="false"><![CDATA[

		]]></sql>
	</changeSet>
-->
	<changeSet id="mantis-10" author="rowmat-dml">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>
		<sqlFile path="sales-analys-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="mantis-14" author="prior">
		<comment>Удалить ошибочно заведенный заказ</comment>
		<delete tableName="xPredmetyByIzdelia">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="orders">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="sdmcrez">
			<where>numdoc = 8102012</where>
		</delete>
	</changeSet>


	<changeSet id="mantis-19" author="prior-ddl">
		<comment>Перенести отчет по оборотам средств по предприятиям в Stime</comment>
		<addColumn tableName="nAnalys">
			<column name="application" type="varchar(16)"/>
		</addColumn>
		<update tableName="nAnalys">
			<column name="application" value="bay"/>
		</update>
		<update tableName="nAnalys">
			<column name="application" value="stime"/>
			<where>id = 7</where>
		</update>
<!--
		<modifyColumn tableName="nAnalys">
			<column name="application" >
				<constraints nullable="true"/>
			</column>
		</modifyColumn>
-->
	</changeSet>

<!--
	<changeSet id="mantis-12" author="code" runOnChange="true">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="nomnom-firma.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


	<changeSet id="mantis-12" author="dml">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="nomnom-firma-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="bay-analys" author="dml">
		<comment>Пропущенные при дизайне ЕР-схемы ключи ссылок</comment>
		<addForeignKeyConstraint constraintName="f_fk_row_col" baseTableName="nFilter" baseColumnNames="byrowid, bycolumnid"
    	referencedTableName="nAnalys" referencedColumnNames="byrow, bycolumn"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nAnalysBooting" constraintName="nab_param" baseColumnNames="paramId"
    	referencedTableName="nAnalysBootingParam" referencedColumnNames="id"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nHeaderColumSelected" constraintName="nhcs_manag" baseColumnNames="managerId"
    	referencedTableName="GuideManag" referencedColumnNames="managId"
    	onDelete="SET NULL" onUpdate="CASCADE"
    	/>
	</changeSet>
-->

<!--
!!! почему-то не работает из-под ликвибейза. Возможно неправильно настрое автокоммит?? хорошо бы разобраться...

	<changeSet id="mantis-23" author="dml">
		<comment>синхронизировать справочник фирм с бухгалтерскими базами комтеха.</comment>
		<sqlFile path="sync_guidefirms.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
-->

	<changeSet id="ddl-1" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="orders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="ddl-2" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="bayOrders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="dml-1" author="mantis-33">
		<comment>Установка Курса по умолчанию</comment>
		<update tableName="orders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="orders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>

		<update tableName="bayOrders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="bayOrders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>
		
		<rollback/>
	</changeSet>


	<changeSet id="code-1" author="mantis-33" runOnChange="true">
		<comment>Курс заказа: триггеры для orders</comment>
		<sqlFile path="mantis-33.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>

		<rollback/>
	</changeSet>

	<changeSet id="ddl-3" author="mantis-33">
		<comment>Колонка курс в таблице проводок.</comment>
		<addColumn tableName="yBook">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="dml-2" author="mantis-33" runOnChange="true">
		<comment>Update колонки курс в таблице проводок.</comment>
		<update tableName="yBook">
			<column name="rate" valueNumeric="30"/>
		</update>

		<sql splitStatements="false" stripComments="false"><![CDATA[
select 1			
		]]></sql>

		<rollback/>
	</changeSet>

	<changeSet id="ddl-4" author="mantis-33">
		<comment>Столбец id в таблице проводок, для создания первичного ключа</comment>
		<addColumn tableName="yBook">
			<column name="id" type="int">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>
<!--
	<changeSet id="dml-3" author="mantis-33">
		<comment>Проинициализировать id в таблице проводок</comment>
		<sqlFile splitStatements="false" stripComments="false" path="mantis-33-dml-3.sql" encoding="cp1251"/>
	</changeSet>
-->
	<changeSet id="ddl-5" author="mantis-33">
		<comment>Создать столбец id автоинкрементным</comment>
		<sql><![CDATA[
alter table ybook modify id not null default autoincrement
		]]></sql>
	</changeSet>

	<changeSet id="ddl-6" author="mantis-33">
		<comment>Создать первичный ключ для таблицы проводок</comment>
		<addPrimaryKey tableName="yBook" constraintName="pk_ybook" columnNames="id"/>
	</changeSet>

	<changeSet id="code-2" author="mantis-33" runOnChange="true">
		<sql splitStatements="false" stripComments="false">

if exists (select 1 from sysprocedure where proc_name = 'retrieve_xoz_rub') then
	drop function retrieve_xoz_rub;
end if;

create 
	function retrieve_xoz_rub
	(
		p_id   integer
	)
returns float
begin
	declare v_server    varchar(50);
	declare v_id_xoz   integer;

	select v.sysname, b.id_xoz
	into v_server, v_id_xoz
	from ybook b
	join guideVenture v on v.ventureid = b.ventureid
	where b.id = p_id;

	set retrieve_xoz_rub = select_remote(v_server, 'xoz', 'sum', 'id = ' + convert(varchar(20), v_id_xoz));
	
end;


		</sql>
	</changeSet>

	<changeSet id="dml-4" author="mantis-33" runOnChange="true">
		<comment>Заставить просмотреть курсы всех проводок начиная с 12 января</comment>
		<update tableName="yBook">
			<column name="rate" valueNumeric="0"/>
			<where><![CDATA[xdate >= '20090112']]></where>
		</update>

		<rollback/>
	</changeSet>

	<changeSet id="rollback-1" author="mantis-12" runOnChange="true">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)  ROLLBACK</comment>
		<sqlFile path="report-nomnom-byfirma-rollback.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="1" author="mantis-49" runOnChange="true">
		<comment>Алгоритм расчета "к заявке": не учитывать пропущенные дни.</comment>
		<sqlFile path="procedures/wf_sale_turnover_metrics.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/wf_sale_turnover_metrics.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="1" author="mantis-52" runOnChange="false">
		<comment>Добавить столбец "Маржа" к таблице номенклатуры</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="margin" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
<!--
	<changeSet id="2" author="mantis-52" runOnChange="false">
		<comment>Проставить значения маржи из формулы.</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="C:\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\update_margin_for_sale.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>
-->
	<changeSet id="3" author="mantis-52" runOnChange="false">
		<comment>Вместо номера формулы - маржа - Сбросить внешний ключ.</comment>
		<dropForeignKeyConstraint baseTableName="sGuideNomenk" constraintName="sguideformulssguidenomenk1"/>
		<rollback/>
	</changeSet>
	
	<changeSet id="4" author="mantis-52" runOnChange="false">
		<comment>Вместо номера формулы - маржа: удалить столбец</comment>
		<dropColumn tableName="sGuideNomenk" columnName="formulaNomW"/>
		<rollback/>
	</changeSet>

	<changeSet id="5" author="mantis-52" runOnChange="false">
		<comment>Коэффициент деления и к-во колонок</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="kodel" type="float"><constraints nullable="true"/></column>
			<column name="kolonok" type="integer"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="6" author="mantis-52" runOnChange="false">
		<comment>Коэффициент деления и к-во колонок: значения по умолчанию</comment>
		<update tableName="sGuideNomenk">
			<column name="kodel" value="0.5"/>
		</update>
		<update tableName="sGuideNomenk">
			<column name="kolonok" value="4"/>
		</update>
		<rollback/>

	</changeSet>

	<changeSet id="7" author="mantis-52" runOnChange="false">
		<comment>Названия колонок - в таблице Классов</comment>
		<addColumn tableName="sGuideKlass">
			<column name="kolon1" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon2" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon3" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon4" type="varchar(64)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="8" author="mantis-52" runOnChange="false">
		<comment>Ручные значения отповых цен</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="CenaOpt2" type="float"><constraints nullable="true"/></column>
			<column name="CenaOpt3" type="float"><constraints nullable="true"/></column>
			<column name="CenaOpt4" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="1" author="mantis-55" runOnChange="false">
		<comment>Изменить название фирмы в комтехе при редактировании имени в справочнике фирм в приоре и продажах.</comment>
		<sqlFile path="triggers/wf_update_firm.guidefirms.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/wf_update_firm.bayguidefirms.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

	<changeSet id="2" author="mantis-55" runOnChange="false">
		<comment>Ошибка при заведении заказа для фирмы Фараон</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-55.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

</databaseChangeLog>

