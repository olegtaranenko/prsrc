<?xml version="1.0" encoding="CP1251"?>
 
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
		 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"
  logicalFilePath="changeset-prior.xml"
>
 

	<include file="changeset-common.xml"/>


<!--

	<changeSet id="ddl" author="mantis-7" context="does-not-work">
		<comment>Prepare for repare table xPredmetyByNomenkOut from the backup</comment>
		<sql>
create server priord class 'ASAODBC' USING 'DSN=dev_prior;UID=dba;PWD=sql';

call build_table_one_server('xPredmetyByNomenkOut', 'priord', 1);
		</sql>

		<rollback>
			<sql>
call build_table_one_server('xPredmetyByNomenkOut', 'priord', 0);
drop server priord;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="dml" author="mantis-7" runOnChange="false" context="does-not-work">
		<comment>Correct broken table xPredmetyByNomenkOut from the backup</comment>
		<createProcedure>
begin
	create table #nomOut(outDate timestamp, numorder integer, nomnom varchar(50), quant float, used integer);

	insert into #nomOut
	select outDate, numorder, nomnom, quant, 0
	from xPredmetyByNomenkOut_priord o;


	for x as xx dynamic scroll cursor for
		select numorder as r_numorder, nomnom as r_nomnom, quant as r_quant from xPredmetyByNomenkOut for update
	do
		lea:
		for y as yy dynamic scroll cursor for
			select outDate as r_outDate from #nomOut o where o.numorder = r_numorder and o.nomnom = r_nomnom and quant = r_quant and o.used = 0 for update
		do
			update xPredmetyByNomenkOut set outDate = r_outDate where current of xx;
			update #nomOut set used = 1 where current of yy;
			leave lea;
		end for;
		commit;
	end for;

end;
		</createProcedure>
	</changeSet>
-->

	<changeSet id="mantis-11" author="ddl">
		<comment>Temporarly restore sales functionality</comment>
		<addColumn tableName="bayguidefirms">
			<column name="oborud" type="varchar(10)"><constraints nullable="true"/></column>
		</addColumn>
		<addColumn tableName="bayguidefirms">
			<column name="kategor" type="varchar(50)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
	

<!--
	<changeSet id="mantis-11" author="test-exception" runOnChange="false">
		<sql splitStatements="true" stripComments="true" endDelimiter=";">

	truncate table sdmcventure;
	truncate table sdocsventure;

//	call bootstrap_blocking();

	call cre_block_var('supress_cum_update');
	call cre_block_var('supress_diary_update');
	waitfor delay convert(time, '00:00:01.000');

//	call cre_block_var('supress_cum_update');
//	call cre_block_var('supress_diary_update');

//	call cre_block_var('blocks_inited');

	call ivo_generate(10);


		</sql>
	</changeSet>

	<changeSet id="mantis-10" author="correct-ivo" runOnChange="false">
		<sqlFile path="correct-ivo.sql" splitStatements="false" stripComments="false"/>
	</changeSet>
-->

	<changeSet id="mantis-10" author="code" runOnChange="true">
		<comment>Процедуры для анализа продаж</comment>
		<sqlFile path="procedures/sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


<!--
	<changeSet id="mantis-10" author="rowmat-dml" runAlways="true">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>

		<sqlFile path="sales-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sql splitStatements="false" stripComments="false"><![CDATA[

		]]></sql>
	</changeSet>
-->
	<changeSet id="mantis-10" author="rowmat-dml">
		<comment>Подготовить "Отчет об остатках по материалам по предприятиям"</comment>
		<sqlFile path="sales-analys-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="mantis-14" author="prior">
		<comment>Удалить ошибочно заведенный заказ</comment>
		<delete tableName="xPredmetyByIzdelia">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="orders">
			<where>numorder = 8102012</where>
		</delete>
		<delete tableName="sdmcrez">
			<where>numdoc = 8102012</where>
		</delete>
	</changeSet>


	<changeSet id="mantis-19" author="prior-ddl">
		<comment>Перенести отчет по оборотам средств по предприятиям в Stime</comment>
		<addColumn tableName="nAnalys">
			<column name="application" type="varchar(16)"/>
		</addColumn>
		<update tableName="nAnalys">
			<column name="application" value="bay"/>
		</update>
		<update tableName="nAnalys">
			<column name="application" value="stime"/>
			<where>id = 7</where>
		</update>
<!--
		<modifyColumn tableName="nAnalys">
			<column name="application" >
				<constraints nullable="true"/>
			</column>
		</modifyColumn>
-->
	</changeSet>

<!--
	<changeSet id="mantis-12" author="code" runOnChange="false">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="nomnom-firma.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>


	<changeSet id="mantis-12" author="dml">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)</comment>
		<sqlFile path="nomnom-firma-dml.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="bay-analys" author="dml">
		<comment>Пропущенные при дизайне ЕР-схемы ключи ссылок</comment>
		<addForeignKeyConstraint constraintName="f_fk_row_col" baseTableName="nFilter" baseColumnNames="byrowid, bycolumnid"
    	referencedTableName="nAnalys" referencedColumnNames="byrow, bycolumn"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nAnalysBooting" constraintName="nab_param" baseColumnNames="paramId"
    	referencedTableName="nAnalysBootingParam" referencedColumnNames="id"
    	onDelete="CASCADE" onUpdate="CASCADE"
    	/>

		<addForeignKeyConstraint baseTableName="nHeaderColumSelected" constraintName="nhcs_manag" baseColumnNames="managerId"
    	referencedTableName="GuideManag" referencedColumnNames="managId"
    	onDelete="SET NULL" onUpdate="CASCADE"
    	/>
	</changeSet>
-->

<!--
!!! почему-то не работает из-под ликвибейза. Возможно неправильно настрое автокоммит?? хорошо бы разобраться...

	<changeSet id="mantis-23" author="dml">
		<comment>синхронизировать справочник фирм с бухгалтерскими базами комтеха.</comment>
		<sqlFile path="sync_guidefirms.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
-->

	<changeSet id="ddl-1" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="orders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="ddl-2" author="mantis-33">
		<comment>Курс УЕ для каждого заказа (ДДЛ)</comment>
		<addColumn tableName="bayOrders">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="dml-1" author="mantis-33">
		<comment>Установка Курса по умолчанию</comment>
		<update tableName="orders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="orders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>

		<update tableName="bayOrders">
			<column name="rate" valueNumeric="30"/>
			<where><![CDATA[indate  between '20040101' and '20090112']]></where>
		</update>
		<update tableName="bayOrders">
			<column name="rate" valueNumeric="35"/>
			<where><![CDATA[indate  >= '20090112']]></where>
		</update>
		
		<rollback/>
	</changeSet>

<!--
	<changeSet id="code-1" author="mantis-33" runOnChange="false">
		<comment>Курс заказа: триггеры для orders</comment>
		<sqlFile path="mantis-33.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>

		<rollback/>
	</changeSet>
-->

	<changeSet id="ddl-3" author="mantis-33">
		<comment>Колонка курс в таблице проводок.</comment>
		<addColumn tableName="yBook">
			<column name="rate" type="float">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="dml-2" author="mantis-33" runOnChange="false">
		<comment>Update колонки курс в таблице проводок.</comment>
		<update tableName="yBook">
			<column name="rate" valueNumeric="30"/>
		</update>

		<sql splitStatements="false" stripComments="false"><![CDATA[
select 1			
		]]></sql>

		<rollback/>
	</changeSet>

	<changeSet id="ddl-4" author="mantis-33">
		<comment>Столбец id в таблице проводок, для создания первичного ключа</comment>
		<addColumn tableName="yBook">
			<column name="id" type="int">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>
<!--
	<changeSet id="dml-3" author="mantis-33">
		<comment>Проинициализировать id в таблице проводок</comment>
		<sqlFile splitStatements="false" stripComments="false" path="mantis-33-dml-3.sql" encoding="cp1251"/>
	</changeSet>
-->
	<changeSet id="ddl-5" author="mantis-33">
		<comment>Создать столбец id автоинкрементным</comment>
		<sql><![CDATA[
alter table ybook modify id not null default autoincrement
		]]></sql>
	</changeSet>

	<changeSet id="ddl-6" author="mantis-33">
		<comment>Создать первичный ключ для таблицы проводок</comment>
		<addPrimaryKey tableName="yBook" constraintName="pk_ybook" columnNames="id"/>
	</changeSet>

	<changeSet id="code-2" author="mantis-33" runOnChange="false">
		<sql splitStatements="false" stripComments="false">

if exists (select 1 from sysprocedure where proc_name = 'retrieve_xoz_rub') then
	drop function retrieve_xoz_rub;
end if;

create 
	function retrieve_xoz_rub
	(
		p_id   integer
	)
returns float
begin
	declare v_server    varchar(50);
	declare v_id_xoz   integer;

	select v.sysname, b.id_xoz
	into v_server, v_id_xoz
	from ybook b
	join guideVenture v on v.ventureid = b.ventureid
	where b.id = p_id;

	set retrieve_xoz_rub = select_remote(v_server, 'xoz', 'sum', 'id = ' + convert(varchar(20), v_id_xoz));
	
end;


		</sql>
	</changeSet>

	<changeSet id="dml-4" author="mantis-33" runOnChange="false">
		<comment>Заставить просмотреть курсы всех проводок начиная с 12 января</comment>
		<update tableName="yBook">
			<column name="rate" valueNumeric="0"/>
			<where><![CDATA[xdate >= '20090112']]></where>
		</update>

		<rollback/>
	</changeSet>

	<changeSet id="rollback-1" author="mantis-12" runOnChange="false">
		<comment>Отчет для продаж - ВСЕ материалы купленные фирмой(ами)  ROLLBACK</comment>
		<sqlFile path="report-nomnom-byfirma-rollback.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="1" author="mantis-49" runOnChange="false">
		<comment>Алгоритм расчета "к заявке": не учитывать пропущенные дни.</comment>
		<sqlFile path="procedures/wf_sale_turnover_metrics.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/wf_sale_turnover_metrics.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="1" author="mantis-52" runOnChange="false">
		<comment>Добавить столбец "Маржа" к таблице номенклатуры</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="margin" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
<!--
	<changeSet id="2" author="mantis-52" runOnChange="false">
		<comment>Проставить значения маржи из формулы.</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="C:\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\update_margin_for_sale.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>
-->
	<changeSet id="3" author="mantis-52" runOnChange="false">
		<comment>Вместо номера формулы - маржа - Сбросить внешний ключ.</comment>
		<dropForeignKeyConstraint baseTableName="sGuideNomenk" constraintName="sguideformulssguidenomenk1"/>
		<rollback/>
	</changeSet>
	
	<changeSet id="4" author="mantis-52" runOnChange="false">
		<comment>Вместо номера формулы - маржа: удалить столбец</comment>
		<dropColumn tableName="sGuideNomenk" columnName="formulaNomW"/>
		<rollback/>
	</changeSet>

	<changeSet id="5" author="mantis-52" runOnChange="false">
		<comment>Коэффициент деления и к-во колонок</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="kodel" type="float"><constraints nullable="true"/></column>
			<column name="kolonok" type="integer"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="6" author="mantis-52" runOnChange="false">
		<comment>Коэффициент деления и к-во колонок: значения по умолчанию</comment>
		<update tableName="sGuideNomenk">
			<column name="kodel" value="0.5"/>
		</update>
		<update tableName="sGuideNomenk">
			<column name="kolonok" value="4"/>
		</update>
		<rollback/>

	</changeSet>

	<changeSet id="7" author="mantis-52" runOnChange="false">
		<comment>Названия колонок - в таблице Классов</comment>
		<addColumn tableName="sGuideKlass">
			<column name="kolon1" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon2" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon3" type="varchar(64)"><constraints nullable="true"/></column>
			<column name="kolon4" type="varchar(64)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="8" author="mantis-52" runOnChange="false">
		<comment>Ручные значения отповых цен</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="CenaOpt2" type="float"><constraints nullable="true"/></column>
			<column name="CenaOpt3" type="float"><constraints nullable="true"/></column>
			<column name="CenaOpt4" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="1" author="mantis-55" runOnChange="false">
		<comment>Изменить название фирмы в комтехе при редактировании имени в справочнике фирм в приоре и продажах.</comment>
		<sqlFile path="triggers/wf_update_firm.guidefirms.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/wf_update_firm.bayguidefirms.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

	<changeSet id="2" author="mantis-55" runOnChange="true">
		<comment>Ошибка при заведении заказа для фирмы Фараон</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-55.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	<changeSet id="1" author="mantis-58" runOnChange="false">
		<comment>Изменить алгоритм взятия цены из Комтеха</comment>
		<sqlFile path="procedures/wf_cost_bulk_change.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="2" author="mantis-58" runOnChange="false">
		<comment>Изменить алгоритм взятия цены из Комтеха - remote procedure recompile</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\rp_wf_calc_cost.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	<changeSet id="1" author="mantis-62" runOnChange="false">
		<comment>Таблицу констант для расчета формул</comment>
		<createTable tableName="GuideConstants">
			<column name="constantsId" type="integer" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="pk_constant"/>
			</column>
			<column name="constants" type="varchar(64)" >
				<constraints nullable="false"/>
			</column>
			<column name="value" type="float" defaultValueNumeric="0.0">
				<constraints nullable="false"/>
			</column>
			<column name="Note" type="varchar(256)"/>
		</createTable>
	</changeSet>

<!--
	<changeSet id="2" author="mantis-62" runOnChange="false">
		<insert tableName="GuideConstants">
			<column name="constants" value="EUR"/>
			<column name="value" value="1.045"/>
		</insert>
		<rollback><delete tableName="GuideConstants"></delete></rollback>
	</changeSet>
-->

	<changeSet id="1" author="mantis-44" runOnChange="true">
		<comment></comment>
		<sqlFile path="triggers/sDmcRez.wf_update_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>
	
	<changeSet id="0" author="mantis-12" runOnChange="false">
		<comment>Процедуры для нового отчета</comment>
		<dropUniqueConstraint tableName="nResultColumns" uniqueColumns="headerId, columnId" constraintName="dummy"/>
	</changeSet>

	<changeSet id="1" author="mantis-12" runOnChange="true">
		<comment>Отчет "Все купленный фирмой материалы</comment>
		<sqlFile path="mainteinance/climat-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
<!--
	<changeSet id="2" author="mantis-12" runOnChange="false">
		<comment>Процедуры для нового отчета</comment>
		<sqlFile path="procedures/n_analys_value.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/n_get_analysid.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/n_exec_header.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/n_exec_filter.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/n_list_climat_by_periods.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
-->

<!--
	<changeSet id="1" author="mantis-20" runOnChange="true">
		<comment>Отчет "Все купленный фирмой материалы</comment>
		<sqlFile path="mainteinance/climat-analys.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>
-->

	<changeSet id="1" author="mantis-71" runOnChange="true">
		<comment>при смене курса не пересчитывается рубли в комтехе</comment>
		<sqlFile path="triggers/Orders.wf_update_orders.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
	</changeSet>

	<changeSet id="2" author="mantis-71" runOnChange="false">
		<comment>Таблица для хранения Типов Бизнес-Проблем</comment>
		<createTable tableName="iIssueType">
			<column name="issueTypeId" type="int" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="IIT_PK"/>
			</column>
			<column name="sysname" type="varchar(63)">
				<constraints nullable="false"/>
			</column>
			<column name="msgCode" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="long varchar">
				<constraints nullable="true"/>
			</column>
			<column name="action" type="long varchar">
				<constraints nullable="true"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="3" author="mantis-71" runOnChange="false">
		<comment>Таблица для хранения Типов Деталировки Бизнес-Проблем</comment>
		<createTable tableName="iIssueDetailType">
			<column name="issueDetailTypeId" type="int" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="IDT_PK"/>
			</column>
			<column name="sysname" type="varchar(63)">
				<constraints nullable="false"/>
			</column>
			<column name="issueTypeId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="issueClass" type="varchar(16)">
				<constraints nullable="true"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="4" author="mantis-71" runOnChange="false">
		<comment>Таблица для хранения Бизнес-Проблем</comment>
		<createTable tableName="iBusinessIssue">
			<column name="issueId" type="int" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="IBI_PK"/>
			</column>
			<column name="issueTypeId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="issueMarker" type="varchar(32)">
				<constraints nullable="true"/>
			</column>
			<column name="occuredTime" type="datetime" defaultValueDate="now()">
				<constraints nullable="false"/>
			</column>
			<column name="ManagId" type="tinyint" >
				<constraints nullable="true"/>
			</column>
			<column name="msg" type="long varchar">
				<constraints nullable="true"/>
			</column>
			<column name="application" type="varchar(15)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>


	<changeSet id="5" author="mantis-71" runOnChange="false">
		<comment>Таблица для хранения Детализации Бизнес-Проблем</comment>
		<createTable tableName="iIssueDetail">
			<column name="issueDetailId" type="int" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="IID_PK"/>
			</column>
			<column name="issueId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="issueDetailTypeId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="varchar(63)">
				<constraints nullable="false"/>
			</column>
			<column name="seqOrder" type="tinyint">
				<constraints nullable="true"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="6" author="mantis-71" runOnChange="false">
		<addForeignKeyConstraint baseTableName="iIssueDetail" constraintName="IID_IssueId" baseColumnNames="issueId"
			referencedTableName="iBusinessIssue" referencedColumnNames="issueId"
			onDelete="CASCADE" onUpdate="CASCADE"
		/>
	</changeSet>

	<changeSet id="7" author="mantis-71" runOnChange="false">
		<addForeignKeyConstraint baseTableName="iIssueDetail" constraintName="IID_IssueDetailTypeId" baseColumnNames="issueDetailTypeId"
			referencedTableName="iIssueDetailType" referencedColumnNames="issueDetailTypeId"
			onDelete="CASCADE" onUpdate="CASCADE"
		/>
	</changeSet>

	<changeSet id="8" author="mantis-71" runOnChange="false">
		<addForeignKeyConstraint baseTableName="iBusinessIssue" constraintName="IBI_IssueTypeId" baseColumnNames="issueTypeId"
			referencedTableName="iIssueType" referencedColumnNames="issueTypeId"
			onDelete="CASCADE" onUpdate="CASCADE"
		/>
	</changeSet>

	<changeSet id="9" author="mantis-71" runOnChange="false">
		<addForeignKeyConstraint baseTableName="iIssueDetailType" constraintName="IDI_IssueTypeId" baseColumnNames="issueTypeId"
			referencedTableName="iIssueType" referencedColumnNames="issueTypeId"
			onDelete="CASCADE" onUpdate="CASCADE"
		/>
	</changeSet>


	<changeSet id="10" author="mantis-71" runOnChange="false">
		<comment>Добавить типов Бизнес-Проблем</comment>
		<insert tableName="iIssueType">
			<column name="sysname" value="ref-nomenk-missed"/>
			<column name="msgCode" value="17002"/>
			<column name="description" value="У заказа отсутствуют ссылки одной или нескольких позиций материала или изделия в бухгалтерии"/>
			<column name="action" value="Необходимо связаться с бухгалтерией по поводу заказа и предупредить их о необходимости ручной корректировки рублевой стоимости"/>
		</insert>
		<rollback><delete tableName="GuideConstants"></delete></rollback>
	</changeSet>

	<changeSet id="11" author="mantis-71" runOnChange="true">
		<comment>процедура взятия слудующего элемента для Бизнес-Проблемы</comment>
		<sqlFile path="procedures/wi_post_new_issue.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_add_issue_attribute.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_get_msgcode.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_gen_issue_marker.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_reset_issue_marker.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_check_business_issue.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/wi_check_issue_action.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<rollback/>
	</changeSet>
	<changeSet id="12" author="mantis-71" runOnChange="false">
		<comment>заполнить таблицу Типов Деталировки Issue</comment>
		<loadData tableName="iIssueDetailType" file="data/iIssueDetailType.csv">
			<column header="issueDetailTypeId" type="NUMERIC" />
			<column header="sysname" type="STRING" />
			<column header="issueTypeId" type="NUMERIC" />
			<column header="issueClass" type="STRING" />
		</loadData>
	</changeSet>




	<changeSet id="0.1" author="mantis-72" runOnChange="false">
		<insert tableName="nResultColumnDef">
			<column name="name"    value="orderMatQty"/>
			<column name="name_ru" value="Зак.с мат."/>
			<column name="headType"    valueNumeric="2"/>
			<column name="sort"    valueNumeric="550"/>
		</insert>
	</changeSet>


	<changeSet id="0.2" author="mantis-72" runOnChange="false">
		<insert tableName="nResultColumns">
			<column name="headerId" valueNumeric="1"/>
			<column name="columnId" valueNumeric="20"/>
		</insert>
	</changeSet>


	<changeSet id="0.3" author="mantis-72" runOnChange="false">
		<delete tableName="nResultColumns">
			<where>headerid = 1 and columnId = 8</where>
		</delete>
	</changeSet>


	<changeSet id="1" author="mantis-72" runOnChange="true">
		<comment>Исправить заголовки для Отчета</comment>
		<update tableName="nResultColumnDef">
			<column name="name_ru" value="Зак.всего"/>
			<column name="sort" valueNumeric="1100"/>
			<where>id = 6</where>
		</update>
		<update tableName="nResultColumns">
			<column name="sort" valueNumeric="1100"/>
			<where>headerid = 1 and columnId = 6</where>
		</update>

		<update tableName="nResultColumnDef">
			<column name="name_ru" value="Зак.всего УЕ"/>
			<column name="sort" valueNumeric="1200"/>
			<where>id = 7</where>
		</update>
		<update tableName="nResultColumns">
			<column name="sort" valueNumeric="1200"/>
			<where>headerid = 1 and columnId = 7</where>
		</update>

		<update tableName="nResultColumnDef">
			<column name="name_ru" value="Зак.с мат."/>
			<column name="sort" valueNumeric="600"/>
			<where>id = 8</where>
		</update>
		<update tableName="nResultColumns">
			<column name="sort" valueNumeric="600"/>
			<where>headerid = 1 and columnId = 8</where>
		</update>
	</changeSet>

	<changeSet id="2" author="mantis-72" runOnChange="true">
		<comment>Исправить оснвную процедуру отчета Анализ продаж по фирмы/года-месяцы-...</comment>
		<sqlFile path="procedures/n_list_firm_by_periods.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<sqlFile path="procedures/n_exec_filter.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<rollback/>
	</changeSet>

	<changeSet id="1" author="mantis-11">
		<comment>Remove sales functionality</comment>
		<dropColumn tableName="bayguidefirms" columnName="oborud"/>
		<dropColumn tableName="bayguidefirms" columnName="kategor"/>
	</changeSet>

	<changeSet id="1" author="mantis-81" runOnChange="false">
		<comment>Таблица категорий готовых изделий (призы, награды и т.д.)</comment>
		<createTable tableName="GuideProdCategory">
			<column name="prodCategoryId" type="integer" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="pk_prodCategory"/>
			</column>
			<column name="sysname" type="varchar(64)" >
				<constraints nullable="false"/>
			</column>
			<column name="nameRu" type="varchar(256)"/>
		</createTable>
	</changeSet>

	<changeSet id="2" author="mantis-81" runOnChange="false">
		<comment>Категория гот. изделий и скидка</comment>
		<addColumn tableName="sguideproducts">
			<column name="prodCategoryId" type="integer"><constraints nullable="true"/></column>
		</addColumn>
		<addColumn tableName="sguideproducts">
			<column name="rabbat" type="float" defaultValueNumeric="20"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="3" author="mantis-81" runOnChange="false">
		<comment>Категория по умолчанию (исторически)</comment>
		<insert tableName="GuideProdCategory">
			<column name="sysname" value="web"/>
			<column name="nameRu" value="выводить в справочник"/>
		</insert>
	</changeSet>


	<changeSet id="4" author="mantis-81" runOnChange="false">
		<comment>скидка для продуктов по умолчанию - 20%</comment>
		<update tableName="sGuideProducts">
			<column name="rabbat" valueNumeric="20"/>
		</update>
	</changeSet>

	<changeSet id="5" author="mantis-81" runOnChange="false">
		<comment>web категрия - как ссылка</comment>
		<sql splitStatements="false" stripComments="false"><![CDATA[
update sGuideProducts set prodCategoryId = pc.prodCategoryId
from GuideProdCategory pc
where pc.sysname = sGuideProducts.web
		]]></sql>
	</changeSet>

	<changeSet id="6" author="mantis-81" runOnChange="false">
		<comment>Удаляем столбец web</comment>
		<dropColumn tableName="sGuideProducts" columnName="web"/>
	</changeSet>

	<changeSet id="7" author="mantis-81" runOnChange="false">
		<addForeignKeyConstraint constraintName="fk_gp_category" baseTableName="sGuideProducts" baseColumnNames="prodCategoryId"
			referencedTableName="GuideProdCategory" referencedColumnNames="prodCategoryId"
			onDelete="SET NULL" onUpdate="SET NULL"
		/>
	</changeSet>

	<changeSet id="1" author="mantis-87" runOnChange="true">
		<comment>некорректно апдейтятся цены на номенклатуру</comment>
		<sqlFile path="triggers\xPredmetyByNomenk.wf_update_nomenk.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		<rollback>
			<sqlFile path="rollback\xPredmetyByNomenk.wf_update_nomenk.sql" splitStatements="false" stripComments="false" encoding="cp1251"/>
		</rollback>
	</changeSet>

	<changeSet id="1" author="mantis-91" runOnChange="true">
		<comment>При добавление подгруппы с названием "таблички" в 25 группу возник Run-time error.</comment>
		<update tableName="sGuideNomenk">
			<column name="margin" valueNumeric="20"/>
			<where>margin is null</where>
		</update>
		<update tableName="sGuideNomenk">
			<column name="kodel" valueNumeric="0.5"/>
			<where>kodel is null</where>
		</update>
		<update tableName="sGuideNomenk">
			<column name="kolonok" valueNumeric="1"/>
			<where>kolonok is null</where>
		</update>
	</changeSet>

	<changeSet id="2" author="mantis-87" runOnChange="true">
		<comment>изменить точность денежных столбцов</comment>
		<modifyColumn tableName="xPredmetyByIzdelia">
			<column name="cenaEd" type="double"/>
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xPredmetyByNomenk">
			<column name="cenaEd" type="double"/>
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xPredmetyByIzdeliaOut">
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xPredmetyByNomenkOut">
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xUslugOut">
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xEtapByIzdelia">
			<column name="eQuant" type="double"/>
			<column name="prevQuant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="xEtapByNomenk">
			<column name="eQuant" type="double"/>
			<column name="prevQuant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="sDMC">
			<column name="quant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="sDMCmov">
			<column name="quantity" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="sDMCrez">
			<column name="quantity" type="double"/>
			<column name="curQuant" type="double"/>
			<column name="intQuant" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="sDMCVenture">
			<column name="quant" type="double"/>
			<column name="costed" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="orders">
			<column name="ordered" type="double"/>
			<column name="paid" type="double"/>
			<column name="shipped" type="double"/>
			<column name="rate" type="double"/>
		</modifyColumn>
		<modifyColumn tableName="Bayorders">
			<column name="ordered" type="double"/>
			<column name="paid" type="double"/>
			<column name="shipped" type="double"/>
		</modifyColumn>
	</changeSet>


	<changeSet id="1" author="mantis-94">
		<comment>НДС для Маркмастера</comment>
		<addColumn tableName="GuideVenture">
			<column name="nds" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="2" author="mantis-94">
		<comment>НДС только для Маркмастера</comment>
		<update tableName="GuideVenture">
			<column name="nds" value="0"/>
		</update>
		<update tableName="GuideVenture">
			<column name="nds" value="18"/>
			<where>sysname = 'markmaster'</where>
		</update>
	</changeSet>

	<changeSet id="3" author="mantis-94" runOnChange="true">
		<comment>НДС: триггер добавления предмета к заказу продаж</comment>
		<sqlFile path="triggers/sDmcRez.wf_insert_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/sDmcRez.wf_update_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/BayOrders.wf_update_orders.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>
	
	<changeSet id="4" author="mantis-94" runOnChange="true">
		<comment>НДС: процедура добавления номенклатуры в счет</comment>
		<sqlFile path="procedures/wf_insert_scet.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/wf_set_invoice_detail.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/wf_scet_price_changed.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/wf_set_bay_detail.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="5" author="mantis-94" runOnChange="true">
		<comment>НДС: триггер добавления номенклатуры к заказу</comment>
		<sqlFile path="triggers/xPredmetyByNomenk.wf_insert_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>
	
	<changeSet id="6" author="mantis-94" runOnChange="true">
		<comment>НДС: триггер добавления готового изделия к заказу</comment>
		<sqlFile path="triggers/xPredmetyByIzdelia.wf_insert_izd.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>
	
	<changeSet id="1" author="mantis-96" runOnChange="true">
		<comment>Вместо мержа счетов - запрет</comment>
		<sqlFile path="procedures/wf_check_jscet_busy.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\rp_jscet_check.sql"/>
		</executeCommand>
<!--
		<sqlFile path="mainteinance\rp_jscet_check.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
-->
	</changeSet>

	<changeSet id="1" author="mantis-100" runOnChange="true">
		<comment>Regression: после 96 нельзя удалить предмет из заказа</comment>
		<sqlFile path="triggers/xPredmetyByIzdelia.wf_delete_izd.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/sDmcRez.wf_delete_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/xPredmetyByNomenk.wf_delete_nomenk.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>


	<changeSet id="1" author="mantis-104">
		<comment>Разборки с фирмой Стам</comment>
		<update tableName="bayguidefirms">
			<column name="name" valueNumeric="'я!Не использовать! ' + name"/>
			<where><![CDATA[firmId = 290]]></where>
		</update>
	</changeSet>

	<changeSet id="1" author="mantis-105" runOnChange="true">
		<comment>Ошибка при заведении новой хоз операции</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-105.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	<changeSet id="1" author="mantis-113" runOnChange="true">
		<comment>расходные накладные в продажах</comment>
		<sqlFile path="triggers/sdocs.wf_delete_sdocs.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="2" author="mantis-113" runOnChange="true">
		<comment>без этого индекса невозможно выполнить следующий запрос</comment>
		<createIndex tableName="sDocs" indexName="sdocs_id_jmat" unique="true">
			<column name="id_jmat"/>
		</createIndex>
	</changeSet>

	<changeSet id="3" author="mantis-113" runOnChange="true">
		<comment>Скрипт для удаления оставшихся из-за бага накладных</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-113.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	
	<changeSet id="1" author="mantis-115" runOnChange="true">
		<comment>M-115 списание наклдных по дате</comment>
		<sqlFile path="procedures/wf_dual_distribute.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/sdocs.wf_sdocs_bi.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="1" author="mantis-85" runOnChange="true">
		<comment>M-85 Изменено формирование маски номера заказа и документа</comment>
		<sqlFile path="procedures/wf_next_numdoc.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/wf_next_numorder.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="1" author="mantis-114" runOnChange="true">
		<comment>Двойное списание по ПМ и ММ. Только исправление по накладным. Не обнаружена причина возникновения подобных ситуаций.</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-114.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	<changeSet id="1" author="mantis-129" runOnChange="true">
		<comment>M-129 нельзя из аннулированного заказа удалить, если есть договор уже</comment>
		<sqlFile path="procedures/purge_jscet.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>
<!--
	<changeSet id="1" author="mantis-130" runOnChange="true">
		<comment>Ошибка при заведении новой хоз операции</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="${basedir}\target\classes\mainteinance\mantis-130.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>
-->
	<changeSet id="1" author="mantis-131" runOnChange="true">
		<comment>M-131 ошибка при попытке удалить заказ по HeadHunter</comment>
		<sqlFile path="procedures/put_jdog.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/put_jscet.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="1" author="mantis-139" runOnChange="true">
		<comment>M139 процедура для отчета по остаткам ном-ры, входящей в каталог BrightAwards.</comment>
		<sqlFile path="procedures/wf_report_bright_ostat.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="2" author="mantis-139" runOnChange="true">
		<comment>Рефакторинг отчета остатки по материалам</comment>
		<sqlFile path="procedures/wf_report_mat_ost.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
	</changeSet>

	<changeSet id="1" author="mantis-133" runOnChange="false">
		<comment>Вместо коэффициента деления - скидка по последней колонке</comment>
		<sql>ALTER TABLE sGuideNomenk RENAME [kodel] TO [rabbat]</sql>
	</changeSet>

<!--
	<changeSet id="1" author="mantis-133" runOnChange="false">
		<comment>Добавить столбец "Скидка" к таблице номенклатуры</comment>
		<addColumn tableName="sGuideNomenk">
			<column name="rabbatTmp" type="float"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>
-->

<!--
	<changeSet id="2" author="mantis-133" runOnChange="true">
		<comment>Конвертировать данные по алгоритму из Коэф/деления в Скидку</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="${basedir}\target\classes\mainteinance\kodel2rabbat.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>
-->

	<changeSet id="2" author="mantis-133" runOnChange="true">
		<comment>Скидка по всем позициям - 10 %</comment>
		<update tableName="sGuideNomenk">
			<column name="rabbat" value="10"/>
			<where>kolonok >= 0</where>
		</update>
	</changeSet>


	<changeSet id="1" author="mantis-83" runOnChange="true">
		<comment>Некорректное перемещение гот.изделия</comment>
		<executeCommand executable="dbisqlc.exe">
			<arg value="-c"/>
			<arg value="DSN=prior;UID=dba;PWD=sql"/>
			<arg value="-q"/>
			<arg value="\dev\prsrc\trunk\dbupdate-parent\prior\target\classes\mainteinance\mantis-83.sql"/>
		</executeCommand>
		<rollback/>
	</changeSet>

	<changeSet id="2" author="mantis-83" runOnChange="true">
		<comment>Некорректное перемещение гот.изделия: ошибка в триггере</comment>
		<sqlFile path="triggers/sGuideProducts.wf_update_gproducts.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>




	<changeSet id="1" author="mantis-125" runOnChange="false">
		<comment>Оборудование про заказ</comment>
		<createTable tableName="OrdersEquip">
			<column name="numorder" type="integer" >
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_oe"/>
			</column>
			<column name="equipId" type="integer" >
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_oe"/>
			</column>
			<column name="statusEquipId" type="integer" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="worktime" type="float" defaultValueNumeric="0.0">
				<constraints nullable="false"/>
			</column>
			<column name="worktimeMO" type="float" defaultValueNumeric="0.0">
				<constraints nullable="false"/>
			</column>
			<column name="outDateTime" type="datetime">
				<constraints nullable="true"/>
			</column>
			<column name="lastModified" type="datetime">
				<constraints nullable="true"/>
			</column>
			<column name="lastManagId" type="tinyint">
				<constraints nullable="true"/>
			</column>
		</createTable>
	</changeSet>


	<changeSet id="2" author="mantis-125" runOnChange="false">
		<sql><![CDATA[
insert	into OrdersEquip (numorder, equipId, worktime, worktimeMO, outDateTime, statusEquipId)
select	o.numorder, o.cehId, o.worktime, isnull(mo.worktimeMO, 0.0), o.outDateTime, o.StatusId
from	  orders o
left join ordersMO mo on mo.numorder = o.numorder
where	cehId > 0
		]]></sql>
		<rollback>truncate table OrdersEquip</rollback>
	</changeSet>

	<changeSet id="3" author="mantis-125" runOnChange="false">
		<comment>Денормализованное поле equip в таблице Заказов. Иначе очень долго делается обновление списка заказов</comment>
		<addColumn tableName="Orders">
			<column name="equip" type="varchar(16)"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="4" author="mantis-125" runOnChange="false">
		<sql>
update	Orders set equip = GuideCeh.ceh
from	GuideCeh 
where	GuideCeh.cehId = orders.cehId
		</sql>
		<rollback>truncate table OrdersEquip</rollback>
	</changeSet>



	<changeSet id="5" author="mantis-125" runOnChange="false">
		<comment>Добавить поле Оборудование в таблицу OrdersInCeh, некоторые поля из основной таблицы Orders, а также все поля из OrdersMO</comment>
		<addColumn tableName="OrdersInCeh">
			<column name="DateTimeMO" type="datetime"><constraints nullable="true"/></column>
			<column name="StatM" type="varchar(20)"><constraints nullable="true"/></column>
			<column name="StatO" type="varchar(20)"><constraints nullable="true"/></column>
			<column name="lastModified" type="datetime"><constraints nullable="true"/></column>
			<column name="lastManagId" type="tinyint"><constraints nullable="true"/></column>
		</addColumn>

	</changeSet>

	<changeSet id="7" author="mantis-125" runOnChange="false">
		<comment>Сбросить первичный ключ для переименования столбца</comment>
		<dropPrimaryKey tableName="GuideCeh"/>
	</changeSet>

	<changeSet id="8" author="mantis-125" runOnChange="false">
		<comment>Переименовать cehId -> equipId в таблице GuideEquip</comment>
<!--bug in liquibase 1.9.5 -->
		<sql>ALTER TABLE GuideCeh RENAME [cehId] TO [equipId]</sql>
		<sql>ALTER TABLE GuideCeh RENAME [ceh] TO [equipName]</sql>
		<rollback/>
	</changeSet>

	<changeSet id="9" author="mantis-125" runOnChange="false">
		<renameTable oldTableName="GuideCeh" newTableName="GuideEquip"/>
	</changeSet>


	<changeSet id="10" author="mantis-125" runOnChange="false">
		<comment>Первичный ключ для таблицы оборудования</comment>
		<addPrimaryKey tableName="GuideEquip" columnNames="equipId" constraintName="pk_GuideEquip"/>
	</changeSet>

	<changeSet id="12" author="mantis-125" runOnChange="false">
		<sql>
update	OrdersInCeh
	set 
		 DateTimeMO	= OrdersMO.DateTimeMO
		,StatM		= OrdersMO.StatM
		,StatO		= OrdersMO.StatO
from	OrdersMO
where	OrdersMO.numorder = OrdersInCeh.numorder
		</sql>

		<rollback/>
	</changeSet>

	<changeSet id="13" author="mantis-125" runOnChange="false">
		<dropTable tableName="OrdersMO"/>
	</changeSet>


	<changeSet id="14" author="mantis-125" runOnChange="false">
		<comment>Удаляем столбцы по цеху/времени выполнения/... из таблицы Заказов</comment>
		<dropColumn tableName="Orders" columnName="worktime"/>
	</changeSet>
<!--
	<changeSet id="12" author="mantis-125" runOnChange="false">
		<comment>Сбросить ключ на цех</comment>
		<dropForeignKeyConstraint baseTableName="Orders" constraintName="GuideCehOrders"/>
		<rollback/>
	</changeSet>
-->
	<changeSet id="15" author="mantis-125" runOnChange="false">
		<comment>Переименовать cehId -> werkId</comment>
<!--bug in liquibase 1.9.5		
		<renameColumn tableName="Orders" oldColumnName="outDateTime" newColumnName="outTime" columnDataType="integer"/> 
-->
		<sql>ALTER TABLE Orders RENAME [cehId] TO [werkId]</sql>
		<rollback/>
	</changeSet>

	<changeSet id="16" author="mantis-125" runOnChange="false">
		<comment>Цех в новом обличье - Werk</comment>
		<createTable tableName="GuideWerk">
			<column name="werkId" type="integer" >
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_gw"/>
			</column>
			<column name="werkCode" type="varchar(8)" >
				<constraints nullable="false"/>
			</column>
			<column name="werkName" type="varchar(32)" >
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="17" author="mantis-125" runOnChange="false">
		<insert tableName="GuideWerk">
			<column name="werkId" valueNumeric="2"/>
			<column name="werkCode" value="Цех"/>
			<column name="werkName" value="Основное производство"/>
		</insert>
		<insert tableName="GuideWerk">
			<column name="werkId" valueNumeric="1"/>
			<column name="werkCode" value="Склад"/>
			<column name="werkName" value="Подготовка продажи"/>
		</insert>
		<rollback/>
	</changeSet>

	<changeSet id="18" author="mantis-125" runOnChange="true">
		<comment>Переход к парадигме цех/оборудование</comment>
		<update tableName="Orders">
			<column name="werkId" value="2"/>
		</update>
	</changeSet>

	<changeSet id="19" author="mantis-125" runOnChange="false">
		<comment>Удаляем столбцы по цеху/времени выполнения/... из таблицы Заказов</comment>
<!--bug in liquibase 1.9.5		
		<renameColumn tableName="Orders" oldColumnName="outDateTime" newColumnName="outTime" columnDataType="integer"/> 
-->
		<sql>ALTER TABLE Orders RENAME [outDateTime] TO [outTime]</sql>
		<sql>ALTER TABLE Orders MODIFY [outTime] integer</sql>

		<rollback/>
	</changeSet>
	
	<changeSet id="20" author="mantis-125" runOnChange="true">
		<comment>Время выдачи - в целых часах в основной таблице (в одном экземпляре)</comment>
		<sql>
			update orders set outTime = datepart(hh, oe.outdatetime)
			from ordersequip oe where orders.numorder = oe.numorder
		</sql>

		<sql>update orders set outTime = null where outTime = 0</sql>

		<rollback/>
	</changeSet>
	
	<changeSet id="21" author="mantis-125" runOnChange="false">
		<sql>
update	OrdersEquip set outDatetime = convert(int, outDatetime)
		</sql>
		<rollback/>
	</changeSet>

	<changeSet id="22" author="mantis-125" runOnChange="true">
		<comment>Саммари вьюхи</comment>
		<sqlFile path="procedures/enumEquip.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/vw_OrdersEquipSummary.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="rollback/vw_OrdersInCehSummary.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/vw_OrdersEquipSummary.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
			<sqlFile path="views/vw_OrdersInCehSummary.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="23" author="mantis-125" runOnChange="true">
		<comment>Индекс для Оборудования по Заказу</comment>
		<createIndex tableName="OrdersEquip" indexName="oe_main" unique="true">
			<column name="numorder"/>
			<column name="equipId"/>
		</createIndex>
	</changeSet>

	<changeSet id="24" author="mantis-125" runOnChange="true">
		<comment>Переделка основных вьюх для цеховых форм</comment>
		<sqlFile path="views/wCO2_plus.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wCO2.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wYAG_plus.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/vw_Reestr.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wSUB_plus.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wSUB.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wYAG.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="views/wEbSvodka.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

	<changeSet id="25" author="mantis-125" runOnChange="true">
		<comment>При изменении имени source менять и в комтехе</comment>
		<sqlFile path="triggers/sGuideSource.wf_update_source.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/sGuideSource.wf_update_source.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="26" author="mantis-125" runOnChange="true">
		<comment>Статья расхода "заказчик без работы" теперь будет называться "производство"</comment>
		<update tableName="sGuideSource">
			<column name="sourceName" value="Произ-во"/>
			<where>sourceId = -6</where>
		</update>
		<rollback/>
	</changeSet>
	
	<changeSet id="27" author="mantis-125" runOnChange="true">
		<comment>Саммари вьюха</comment>
		<sqlFile path="procedures/putOrderEquip.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="procedures/deleteOrderEquip.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/putOrderEquip.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
			<sqlFile path="rollback/deleteOrderEquip.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="28" author="mantis-125" runOnChange="true">
		<comment>При изменении имени source менять и в комтехе</comment>
		<sqlFile path="triggers/OrdersEquip.wf_insert.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersEquip.wf_delete.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback>
			<sqlFile path="rollback/OrdersEquip.wf_insert.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
			<sqlFile path="rollback/OrdersEquip.wf_delete.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		</rollback>
	</changeSet>

	<changeSet id="29" author="mantis-125" runOnChange="false">
		<comment>Застарелый ненужный мусор из производственных таблиц</comment>
		<dropColumn tableName="OrdersInCeh" columnName="id_jscet"/>
		<rollback/>
	</changeSet>

	<changeSet id="32" author="mantis-125" runOnChange="true">
		<comment>Перенести логику lastModified на сервер в триггера</comment>
		<sqlFile path="triggers/Orders.wf_lastModified.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersEquip.wf_lastModified.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersEquip.wf_lastModified_delete.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersEquip.wf_lastModified_insert.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersInCeh.wf_lastModified.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersInCeh.wf_lastModified_delete.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<sqlFile path="triggers/OrdersInCeh.wf_lastModified_insert.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

	<changeSet id="33" author="mantis-125" runOnChange="true">
		<comment>процедура выставления ид менеджера в переменную сессии</comment>
		<sqlFile path="procedures/setManagerId.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

	<changeSet id="34" author="mantis-125" runOnChange="false">
		<comment>последний менеджер, изменивший запись по заказу, может быть пустым</comment>
		<dropNotNullConstraint tableName="Orders" columnName="lastManagId"/>
	</changeSet>

	<changeSet id="35" author="mantis-125" runOnChange="false">
		<insert tableName="GuideEquip">
			<column name="equipId" valueNumeric="4"/>
			<column name="equipName" value="RAW"/>
		</insert>
		<rollback><delete tableName="GuideEquip"><where>equipId = 4</where></delete></rollback>
	</changeSet>

	<changeSet id="36" author="mantis-125" runOnChange="false">
		<comment>Настройки для Оборудования</comment>
		<createTable tableName="GuideResurs">
			<column name="equipId" type="integer" >
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_GuideResurs"/>
			</column>
			<column name="KPD" type="float" defaultValueNumeric="0.9">
				<constraints nullable="false"/>
			</column>
			<column name="Nstan" type="float" defaultValueNumeric="1">
				<constraints nullable="false"/>
			</column>
			<column name="NewRes" type="float" defaultValueNumeric="8">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="37" author="mantis-125" runOnChange="true">
		<comment>Системные настройки из таблицы System -> GuideResurs</comment>
		<sql>
insert into GuideResurs (equipId, KPD, Nstan, NewRes)
select 1, KPD_YAG, NstanYAG, newResYAG
from system
		</sql>
		<sql>
insert into GuideResurs (equipId, KPD, Nstan, NewRes)
select 2, KPD_CO2, NstanCO2, newResCO2
from system
		</sql>
		<sql>
insert into GuideResurs (equipId, KPD, Nstan, NewRes)
select 3, KPD_SUB, NstanSUB, newResSUB
from system
		</sql>
		<sql>
insert into GuideResurs (equipId)
select 4
		</sql>
		<rollback/>
	</changeSet>

	<changeSet id="38" author="mantis-52" runOnChange="true">
		<comment>Системные настройки из таблицы System -> GuideResurs</comment>
		<dropColumn tableName="System" columnName="KPD_YAG"/>
		<dropColumn tableName="System" columnName="NstanYAG"/>
		<dropColumn tableName="System" columnName="NewResYAG"/>
		<dropColumn tableName="System" columnName="KPD_CO2"/>
		<dropColumn tableName="System" columnName="NstanCO2"/>
		<dropColumn tableName="System" columnName="NewResCO2"/>
		<dropColumn tableName="System" columnName="KPD_SUB"/>
		<dropColumn tableName="System" columnName="NstanSUB"/>
		<dropColumn tableName="System" columnName="NewResSUB"/>
	</changeSet>

	<changeSet id="39" author="mantis-125" runOnChange="false">
		<comment>Общая таблица Resurs</comment>
		<renameTable oldTableName="ResursYAG" newTableName="Resurs"/>
	</changeSet>

	<changeSet id="40" author="mantis-125" runOnChange="false">
		<comment>Общая таблица Resurs</comment>
		<addColumn tableName="Resurs">
			<column name="equipId" type="integer"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="41" author="mantis-125" runOnChange="true">
		<comment>Общая таблица Resurs</comment>
		<update tableName="Resurs">
			<column name="equipId" value="1"/>
		</update>
	</changeSet>

	<changeSet id="42" author="mantis-125" runOnChange="true">
		<comment>Общая таблица Resurs</comment>
		<sql>
insert into Resurs (equipId, xDate, nomRes)
select 2, xDate, nomRes
from ResursCO2
		</sql>
		<sql>
insert into Resurs (equipId, xDate, nomRes)
select 3, xDate, nomRes
from ResursSUB
		</sql>
		<rollback/>
	</changeSet>

	<changeSet id="43" author="mantis-125" runOnChange="false">
		<comment>Удаляем мусор из таблицы Ресурсов</comment>
		<dropColumn tableName="Resurs" columnName="dopRes_"/>
		<dropColumn tableName="Resurs" columnName="dopEndDay_"/>
	</changeSet>

	<changeSet id="44" author="mantis-125" runOnChange="false">
		<addNotNullConstraint tableName="Resurs" columnName="xDate"/>
		<addNotNullConstraint tableName="Resurs" columnName="equipId"/>
	</changeSet>

	<changeSet id="45" author="mantis-125">
		<comment>Создать первичный ключ для таблицы проводок</comment>
		<addPrimaryKey tableName="Resurs" constraintName="pk_resurs" columnNames="equipId, xDate"/>
	</changeSet>

	<changeSet id="46" author="mantis-125" runOnChange="false">
		<dropTable tableName="ResursCO2"/>
	</changeSet>
	<changeSet id="47" author="mantis-125" runOnChange="false">
		<dropTable tableName="ResursSUB"/>
	</changeSet>


	<changeSet id="48" author="mantis-125" runOnChange="false">
		<comment>Общая таблица Itogi</comment>
		<renameTable oldTableName="Itogi_YAG" newTableName="Itogi"/>
	</changeSet>

	<changeSet id="49" author="mantis-125" runOnChange="false">
		<comment>Общая таблица Itogi</comment>
		<addColumn tableName="Itogi">
			<column name="equipId" type="integer"><constraints nullable="true"/></column>
		</addColumn>
	</changeSet>

	<changeSet id="50" author="mantis-125" runOnChange="true">
		<comment>Общая таблица Itogi</comment>
		<update tableName="Itogi">
			<column name="equipId" value="1"/>
		</update>
	</changeSet>

	<changeSet id="51" author="mantis-125" runOnChange="false">
		<comment>Сбросить первичный ключ для переименования столбца</comment>
		<dropPrimaryKey tableName="Itogi"/>
	</changeSet>

	<changeSet id="52" author="mantis-125" runOnChange="false">
		<comment>Общая таблица Itogi</comment>
		<sql>
insert into Itogi (equipId, xDate, numOrder, obrazec, Virabotka)
select 2, xDate, numOrder, obrazec, Virabotka
from Itogi_CO2
		</sql>
		<sql>
insert into Itogi (equipId, xDate, numOrder, obrazec, Virabotka)
select 3, xDate, numOrder, obrazec, Virabotka
from Itogi_SUB
		</sql>
		<rollback/>
	</changeSet>

	<changeSet id="53" author="mantis-125" runOnChange="false">
		<addNotNullConstraint tableName="Itogi" columnName="equipId"/>
	</changeSet>

	<changeSet id="54" author="mantis-125">
		<comment>Создать первичный ключ для таблицы проводок</comment>
		<addPrimaryKey tableName="Itogi" constraintName="pk_Itogi" columnNames="equipId, numorder, xDate, obrazec"/>
	</changeSet>

	<changeSet id="55" author="mantis-125" runOnChange="false">
		<dropTable tableName="Itogi_CO2"/>
	</changeSet>

	<changeSet id="56" author="mantis-125" runOnChange="false">
		<dropTable tableName="Itogi_SUB"/>
	</changeSet>

	<changeSet id="57" author="mantis-125" runOnChange="true">
		<comment>Процедура: Выставить процент готовности заказа</comment>
		<sqlFile path="procedures/putWerkOrderReady.sql" encoding="cp1251" splitStatements="false" stripComments="false"/>
		<rollback/>
	</changeSet>

</databaseChangeLog>

